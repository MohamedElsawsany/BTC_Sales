
    const sale_btc_products = [
    {name: "ربع جنيه", weight: 2, stampEnduser: 71, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "نصف جنيه", weight: 4, stampEnduser: 66, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "جنيه", weight: 8, stampEnduser: 61, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "2.5 جنيه", weight: 20, stampEnduser: 56, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "خمسة جنيه", weight: 40, stampEnduser: 53, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "عشرة جنيه", weight: 80, stampEnduser: 51, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    
    {name: "ربع جنيه تعليقة", weight: 2.35, stampEnduser: 86, cashback: 8, cashbackunpacking: 8, num1: 1, num2: 1},
    {name: "نصف جنيه تعليقه", weight: 4.35, stampEnduser: 81, cashback: 8, cashbackunpacking: 8, num1: 1, num2: 1},
    {name: "جنيه تعليقة", weight: 8.35, stampEnduser: 76, cashback: 8, cashbackunpacking: 8, num1: 1, num2: 1},

    {name: "ربع جنيه مارفال", weight: 2, stampEnduser: 76, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "نصف جنيه مارفال", weight: 4, stampEnduser: 71, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "جنيه مارفال", weight: 8, stampEnduser: 61, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},
    {name: "5 جنيه مارفال", weight: 40, stampEnduser: 56, cashback: 24, cashbackunpacking: 10, num1: 1, num2: 1},

    {name: "سبيكة 1 جرام", weight: 1, stampEnduser: 172, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 2.5 جرام", weight: 2.5, stampEnduser: 97, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 5 جرام", weight: 5, stampEnduser: 72, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 10 جرام", weight: 10, stampEnduser: 70, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 20 جرام", weight: 20, stampEnduser: 67, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 31.10 جرام", weight: 31.10, stampEnduser: 66, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 50 جرام", weight: 50, stampEnduser: 64, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 100 جرام", weight: 100, stampEnduser: 62, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 116.65 جرام", weight: 116.65, stampEnduser: 51, cashback: 17, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "بيضاوي 5 جرام", weight: 5, stampEnduser: 87, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "بيضاوي 10 جرام", weight: 10, stampEnduser: 82, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "بيضاوي 15.90 جرام", weight: 15.90, stampEnduser: 80, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "بيضاوي 31.45 جرام", weight: 31.45, stampEnduser: 77, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "إسورة 15.55 جرام", weight: 15.55, stampEnduser: 102, cashback: 13.5, cashbackunpacking: 12, num1: 999.9, num2: 875},
    {name: "إسورة 31.10 جرام", weight: 31.10, stampEnduser: 117, cashback: 13.5, cashbackunpacking: 12, num1: 999.9, num2: 875},

    {name: "سبيكة ربع كيلو", weight: 250, stampEnduser: 31, cashback: 12.2, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة نصف كيلو", weight: 500, stampEnduser: 29, cashback: 12.1, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة 1 كيلو", weight: 1000, stampEnduser: 27, cashback: 12.05, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "ربع كيلو دائري", weight: 250, stampEnduser: 32.25, cashback: 14, cashbackunpacking: 14, num1: 999.9, num2: 875},
    {name: "نصف كيلو دائري", weight: 500, stampEnduser: 31.75, cashback: 14, cashbackunpacking: 14, num1: 999.9, num2: 875},
    {name: "1 كيلو دائري", weight: 1000, stampEnduser: 31, cashback: 14, cashbackunpacking: 14, num1: 999.9, num2: 875},

    {name: "هدايا 2.5 جرام", weight: 2.5, stampEnduser: 117, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "هدايا 5 جرام", weight: 5, stampEnduser: 107, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "هدايا 10 جرام", weight: 10, stampEnduser: 93, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "سبيكة ديزني / مارفل 2.5 جرام", weight: 2.5, stampEnduser: 112, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة ديزني / مارفل 5 جرام", weight: 5, stampEnduser: 77, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "سبيكة ديزني / مارفل 10 جرام", weight: 10, stampEnduser: 74, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "قلب تعليقة", weight: 10.35, stampEnduser: 72, cashback: 8, cashbackunpacking: 8, num1: 999.9, num2: 875},

    {name: "الاميرات 5 جرام", weight: 5, stampEnduser: 107, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "الاميرات 10 جرام", weight: 10, stampEnduser: 102, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "الاميرات 15.9 جرام", weight: 15.9, stampEnduser: 97, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "الاميرات 31.10 جرام", weight: 31.10, stampEnduser: 92, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "31.10 جرام خريطة مصر", weight: 31.10, stampEnduser: 72, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},
    {name: "31.10 جرام (السعودية)", weight: 31.10, stampEnduser: 72, cashback: 28.5, cashbackunpacking: 10, num1: 999.9, num2: 875},

    {name: "إسورة 30 جرام سادة", weight: 30, stampEnduser: 121, cashback: 8, cashbackunpacking: 8, num1: 1, num2: 1},
    {name: "إسورة 30 جرام مجدول", weight: 30, stampEnduser: 126, cashback: 8, cashbackunpacking: 8, num1: 1, num2: 1}

];

let rowCount = 1;

// Get current products array based on transaction type
function getCurrentProducts() {
    const selectedType = document.querySelector('input[name="transactionType"]:checked').value;
    return sale_btc_products; // Using same products array but different values based on transaction type
}

// Get the appropriate stamp/enduser value based on transaction type
function getStampEnduserValue(product, transactionType) {
    switch (transactionType) {
        case 'sale':
            return product.stampEnduser;
        case 'return':
            return product.cashback;
        case 'returnUnpacked':
            return product.cashbackunpacking;
        default:
            return product.stampEnduser;
    }
}

// Utility functions
function formatMoney(value) {
    if (isNaN(value) || value === null || value === undefined) return '0';
    return Number(value).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

function parseNumber(value) {
    if (!value) return 0;
    return parseFloat(value.toString().replace(/,/g, '')) || 0;
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    const errorElement = document.getElementById(elementId + 'Error');
    if (element && errorElement) {
        element.parentElement.classList.add('has-error');
        errorElement.textContent = message;
    }
}

function clearError(elementId) {
    const element = document.getElementById(elementId);
    const errorElement = document.getElementById(elementId + 'Error');
    if (element && errorElement) {
        element.parentElement.classList.remove('has-error');
    }
}

function populateProductSelect(select) {
    const currentProducts = getCurrentProducts();
    select.innerHTML = `<option disabled value="0" selected>Select Product</option>`;
    currentProducts.forEach((product, index) => {
        const option = document.createElement("option");
        option.value = index + 1;
        option.textContent = product.name;
        select.appendChild(option);
    });
    // Initialize dataset to track the current transaction type
    select.dataset.previousTransactionType = document.querySelector('input[name="transactionType"]:checked').value;
}

// Update all product rows when transaction type changes
function updateAllProductRows() {
    const selectedTransactionType = document.querySelector('input[name="transactionType"]:checked').value;
    const allSelects = document.querySelectorAll('select[name="productId[]"]');
    const currentProducts = getCurrentProducts();

    allSelects.forEach(select => {
        const rowId = select.id.split('_')[1];
        const selectedIndex = parseInt(select.value) - 1;

        // If a product is selected, update its stamp/enduser value
        if (selectedIndex >= 0 && selectedIndex < currentProducts.length) {
            const selectedProduct = currentProducts[selectedIndex];
            const stampEnduserValue = getStampEnduserValue(selectedProduct, selectedTransactionType);

            // Update the stamp/enduser value for this row
            document.getElementById(`productStampEnduser_${rowId}`).value = stampEnduserValue;

            // Keep other values the same
            document.getElementById(`productWeight_${rowId}`).value = selectedProduct.weight;
            document.getElementById(`productNum1_${rowId}`).value = selectedProduct.num1;
            document.getElementById(`productNum2_${rowId}`).value = selectedProduct.num2;
        }

        // Update the dataset to track the current transaction type
        select.dataset.previousTransactionType = selectedTransactionType;
    });

    // Recalculate prices for all rows
    calculateTotal();
}

function clearRowData(rowId) {
    const fields = ['productWeight', 'productStampEnduser', 'productPrice', 'totalQtyProductPrice', 'productNum1', 'productNum2'];
    fields.forEach(field => {
        const element = document.getElementById(`${field}_${rowId}`);
        if (element) {
            element.value = '';
        }
    });
}

function handleGoldPriceInput(input) {
    clearError('goldPrice');

    // Remove non-numeric characters except decimal point
    let value = input.value.replace(/[^\d.]/g, '');

    // Ensure only one decimal point
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }

    input.value = value;

    if (value && !isNaN(value) && parseFloat(value) > 0) {
        calculateTotal();
    } else if (value) {
        showError('goldPrice', 'Please enter a valid gold price');
    }
}

function handleQuantityInput(input) {
    let value = parseInt(input.value);
    if (isNaN(value) || value < 1) {
        input.value = '';
    } else {
        input.value = value;
        calculateTotal();
    }
}

// Enhanced radio button functionality
function initializeRadioButtons() {
    const radioWrappers = document.querySelectorAll('.radio-wrapper');
    const radioInputs = document.querySelectorAll('input[name="transactionType"]');

    // Set initial state
    updateRadioButtonStates();

    // Add click event listeners to wrapper labels
    radioWrappers.forEach(wrapper => {
        wrapper.addEventListener('click', function() {
            const radioInput = this.querySelector('input[type="radio"]');
            if (radioInput && !radioInput.checked) {
                radioInput.checked = true;
                updateRadioButtonStates();
                handleTransactionTypeChange();
            }
        });
    });

    // Add change event listeners to radio inputs
    radioInputs.forEach(input => {
        input.addEventListener('change', function() {
            updateRadioButtonStates();
            handleTransactionTypeChange();
        });
    });
}

function updateRadioButtonStates() {
    const radioWrappers = document.querySelectorAll('.radio-wrapper');

    radioWrappers.forEach(wrapper => {
        const radioInput = wrapper.querySelector('input[type="radio"]');
        if (radioInput.checked) {
            wrapper.classList.add('selected');
        } else {
            wrapper.classList.remove('selected');
        }
    });
}

function handleTransactionTypeChange() {
    const selectedType = document.querySelector('input[name="transactionType"]:checked').value;
    console.log('Transaction type changed to:', selectedType);

    // Update all product rows with new stamp/enduser values
    updateAllProductRows();
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    populateProductSelect(document.getElementById('productId_1'));
    initializeRadioButtons();
});

document.addEventListener('change', function (e) {
    if (e.target && e.target.matches("select[name='productId[]']")) {
        const select = e.target;
        const rowId = select.id.split('_')[1];
        const selectedIndex = select.selectedIndex - 1;
        const currentProducts = getCurrentProducts();
        const selectedTransactionType = document.querySelector('input[name="transactionType"]:checked').value;

        if (selectedIndex >= 0 && selectedIndex < currentProducts.length) {
            const selectedProduct = currentProducts[selectedIndex];
            const stampEnduserValue = getStampEnduserValue(selectedProduct, selectedTransactionType);

            document.getElementById(`productWeight_${rowId}`).value = selectedProduct.weight;
            document.getElementById(`productStampEnduser_${rowId}`).value = stampEnduserValue;
            document.getElementById(`productNum1_${rowId}`).value = selectedProduct.num1;
            document.getElementById(`productNum2_${rowId}`).value = selectedProduct.num2;

            calculateTotal();
        }
    }
});

document.getElementById('addRows').addEventListener('click', function () {
    rowCount++;
    const tableBody = document.getElementById('productTableBody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
            <td><div class="checkbox-container"><input class="itemRow form-check-input" type="checkbox"></div></td>
            <td>
                <select required name="productId[]" id="productId_${rowCount}" class="form-select">
                    <option disabled value="0" selected>Select Product</option>
                </select>
            </td>
            <td><input type="text" name="productQty[]" id="productQty_${rowCount}" required class="form-control qty" autocomplete="off" placeholder="Qty" min="1" oninput="handleQuantityInput(this)"></td>
            <td style="display: none"><input type="text" readonly name="productWeight[]" id="productWeight_${rowCount}" class="form-control"></td>
            <td style="display: none"><input type="text" readonly name="productStampEnduser[]" id="productStampEnduser_${rowCount}" class="form-control"></td>
            <td><input type="text" required name="productPrice[]" id="productPrice_${rowCount}" class="form-control total-input" autocomplete="off" readonly></td>
            <td><input readonly type="text" name="totalQtyProductPrice[]" id="totalQtyProductPrice_${rowCount}" required class="form-control price total-input" autocomplete="off"></td>
            <td style="display: none"><input readonly type="text" name="productNum1[]" id="productNum1_${rowCount}"></td>
            <td style="display: none"><input readonly type="text" name="productNum2[]" id="productNum2_${rowCount}"></td>
        `;
    tableBody.appendChild(newRow);

    // Populate the new select dropdown
    const newSelect = document.getElementById(`productId_${rowCount}`);
    populateProductSelect(newSelect);
});

document.getElementById('removeRows').addEventListener('click', function () {
    const checkedBoxes = document.querySelectorAll('.itemRow:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one row to delete.');
        return;
    }

    checkedBoxes.forEach(checkbox => {
        checkbox.closest('tr').remove();
    });
    calculateTotal();

    // Uncheck "select all" if no rows remain
    const remainingRows = document.querySelectorAll('.itemRow');
    if (remainingRows.length === 0) {
        document.getElementById('checkAll').checked = false;
    }
});

document.getElementById('checkAll').addEventListener('change', function () {
    const checked = this.checked;
    document.querySelectorAll('.itemRow').forEach(cb => cb.checked = checked);
});

// Update "select all" checkbox based on individual selections
document.addEventListener('change', function(e) {
    if (e.target && e.target.classList.contains('itemRow')) {
        const allCheckboxes = document.querySelectorAll('.itemRow');
        const checkedCheckboxes = document.querySelectorAll('.itemRow:checked');
        const selectAllCheckbox = document.getElementById('checkAll');

        if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
});

function calculateTotal() {
    if (!validateGoldPrice()) {
        return;
    }

    calculateItemPrices();
    calculateGoldPrice24();
}

function validateGoldPrice() {
    const goldPrice = parseNumber(document.getElementById('goldPrice').value);
    if (goldPrice <= 0) {
        showError('goldPrice', 'Please enter a valid gold price greater than 0');
        return false;
    }
    clearError('goldPrice');
    return true;
}

function calculateItemPrices() {
    let totalAmount = 0;
    const goldPrice = parseNumber(document.getElementById('goldPrice').value);
    const currentProducts = getCurrentProducts();
    const selectedTransactionType = document.querySelector('input[name="transactionType"]:checked').value;

    document.querySelectorAll("[id^='productQty_']").forEach(function (element) {
        const id = element.id.split('_')[1];
        const weightElement = document.getElementById(`productWeight_${id}`);
        const stampElement = document.getElementById(`productStampEnduser_${id}`);
        const qtyElement = document.getElementById(`productQty_${id}`);
        const priceElement = document.getElementById(`productPrice_${id}`);
        const totalElement = document.getElementById(`totalQtyProductPrice_${id}`);

        if (!weightElement || !stampElement || !qtyElement || !priceElement || !totalElement) {
            return;
        }

        const weight = parseNumber(weightElement.value);
        const stampEnduser = parseNumber(stampElement.value);
        const quantity = parseNumber(qtyElement.value);
        const num1 = parseNumber(document.getElementById(`productNum1_${id}`)?.value);
        const num2 = parseNumber(document.getElementById(`productNum2_${id}`)?.value);

        if (quantity > 0 && weight > 0 && goldPrice > 0) {
            const soso = num1 / num2;
            let unitPrice, total;

            // Different calculation logic based on transaction type
            if (selectedTransactionType === 'sale') {
                unitPrice = goldPrice * soso + stampEnduser;
                total = weight * quantity * unitPrice;
            } else if (selectedTransactionType === 'return') {
                // For returns, subtract the cashback from gold price
                unitPrice = goldPrice * soso + stampEnduser;
                total = weight * quantity * unitPrice;
            } else if (selectedTransactionType === 'returnUnpacked') {
                // For return unpacked, subtract the cashbackunpacking from gold price
                unitPrice = goldPrice * soso + stampEnduser;
                total = weight * quantity * unitPrice;
            }

            const itemPrice = total / quantity;

            priceElement.value = formatMoney(itemPrice);
            totalElement.value = formatMoney(total);
            totalAmount += total;
        } else {
            priceElement.value = '';
            totalElement.value = '';
        }
    });

    document.getElementById('subTotal').value = formatMoney(totalAmount);
}

function calculateGoldPrice24() {
    const goldPrice = parseNumber(document.getElementById('goldPrice').value);
    if (goldPrice > 0) {
        const price24 = goldPrice * (999.9 / 875);
        document.getElementById('goldPrice24').value = formatMoney(price24);
    } else {
        document.getElementById('goldPrice24').value = '';
    }
}

// Format number inputs on blur
document.addEventListener('blur', function (e) {
    if (e.target && (e.target.id === 'goldPrice' || e.target.id.startsWith('productPrice_'))) {
        const value = parseNumber(e.target.value);
        if (value > 0) {
            e.target.value = formatMoney(value);
        }
    }
}, true);

// Prevent form submission on enter key in input fields
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
        e.preventDefault();
        // Move to next input or trigger calculation
        const form = e.target.closest('form') || document;
        const inputs = Array.from(form.querySelectorAll('input:not([readonly]):not([disabled]), select'));
        const currentIndex = inputs.indexOf(e.target);
        if (currentIndex < inputs.length - 1) {
            inputs[currentIndex + 1].focus();
        }
    }
});

// Initialize tooltips if Bootstrap is available
document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Add loading states for buttons
function showLoading(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
        button.classList.add('loading');
        button.disabled = true;
    }
}

function hideLoading(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
        button.classList.remove('loading');
        button.disabled = false;
    }
}

// Debounce function for better performance
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Debounced calculation for better performance
const debouncedCalculateTotal = debounce(calculateTotal, 300);

// Update gold price input to use debounced calculation
document.getElementById('goldPrice').addEventListener('input', function() {
    handleGoldPriceInput(this);
    debouncedCalculateTotal();
});